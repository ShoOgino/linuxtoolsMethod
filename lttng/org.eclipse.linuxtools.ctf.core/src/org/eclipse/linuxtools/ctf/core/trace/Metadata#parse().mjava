    /**
     * Parse the metadata file.
     * 
     * @throws CTFReaderException
     */
    public void parse() throws CTFReaderException {
        CTFReaderException tempException = null;

        FileInputStream fis = null;
        FileChannel metadataFileChannel = null;

        /*
         * Reader. It will contain a StringReader if we are using packet-based
         * metadata and it will contain a FileReader if we have text-based
         * metadata.
         */
        Reader metadataTextInput = null;

        try {
            fis = new FileInputStream(metadataFile);
            metadataFileChannel = fis.getChannel();

            /* Check if metadata is packet-based */
            if (isPacketBased(metadataFileChannel)) {
                /* Create StringBuffer to receive metadata text */
                StringBuffer metadataText = new StringBuffer();

                /*
                 * Read metadata packet one by one, appending the text to the
                 * StringBuffer
                 */
                MetadataPacketHeader packetHeader = readMetadataPacket(
                        metadataFileChannel, metadataText);
                while (packetHeader != null) {
                    packetHeader = readMetadataPacket(metadataFileChannel,
                            metadataText);
                }

                /* Wrap the metadata string with a StringReader */
                metadataTextInput = new StringReader(metadataText.toString());
            } else {
                /* Wrap the metadata file with a FileReader */
                metadataTextInput = new FileReader(metadataFile);
            }

            /* Create an ANTLR reader */
            ANTLRReaderStream antlrStream;
            antlrStream = new ANTLRReaderStream(metadataTextInput);

            /* Parse the metadata text and get the AST */
            CTFLexer ctfLexer = new CTFLexer(antlrStream);
            CommonTokenStream tokens = new CommonTokenStream(ctfLexer);
            CTFParser ctfParser = new CTFParser(tokens, false);
            parse_return ret;

            ret = ctfParser.parse();

            CommonTree tree = (CommonTree) ret.getTree();

            /* Generate IO structures (declarations) */
            IOStructGen gen = new IOStructGen(tree, trace);
            gen.generate();

        } catch (FileNotFoundException e) {
            tempException = new CTFReaderException("Cannot find metadata file!"); //$NON-NLS-1$
        } catch (IOException e) {
            /* This would indicate a problem with the ANTLR library... */
            tempException = new CTFReaderException(e);
        } catch (ParseException e) {
            tempException = new CTFReaderException(e);
        } catch (RecognitionException e) {
            /*
             * We don't want to expose this ANTLR-specific exception type to the
             * outside..
             */
            tempException = new CTFReaderException(e);
        }

        /* Ghetto resource management. Java 7 will deliver us from this... */
        if (metadataTextInput != null) {
            try {
                metadataTextInput.close();
            } catch (IOException e) {
            }
        }
        if (metadataFileChannel != null) {
            try {
                metadataFileChannel.close();
            } catch (IOException e) {
            }
        }
        if (fis != null) {
            try {
                fis.close();
            } catch (IOException e) {
            }
        }

        if (tempException != null) {
            throw tempException;
        }
    }

