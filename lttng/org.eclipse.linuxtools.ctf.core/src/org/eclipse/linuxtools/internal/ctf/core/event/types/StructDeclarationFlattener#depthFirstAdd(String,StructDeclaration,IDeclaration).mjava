    private static void depthFirstAdd(String path, StructDeclaration flatStruct, IDeclaration dec) {
        if (dec instanceof ISimpleDatatypeDeclaration) {
            flatStruct.addField(path, dec);
        } else if (dec instanceof ArrayDeclaration) {
            ArrayDeclaration ad = (ArrayDeclaration) dec;
            int lastIndexOf = path.lastIndexOf('.');

            String name = (lastIndexOf > 0) ? path.substring(lastIndexOf) : path;
            if (((ArrayDeclaration) dec).isString()) {
                flatStruct.addField(path, dec);
            } else {
                for (int i = 0; i < ad.getLength(); i++) {
                    depthFirstAdd(path + '.' + name + '[' + i + ']', flatStruct, ad.getElementType());
                }
            }
        } else if (dec instanceof StructDeclaration) {
            StructDeclaration sDec = ((StructDeclaration) dec);
            for (String name : sDec.getFieldsList()) {
                depthFirstAdd(path + '.' + name, flatStruct, sDec.getField(name));
            }
        }
    }

