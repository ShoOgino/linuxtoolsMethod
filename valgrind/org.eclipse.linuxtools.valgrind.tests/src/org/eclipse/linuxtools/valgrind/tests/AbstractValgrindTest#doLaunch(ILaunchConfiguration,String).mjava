	protected ILaunch doLaunch(ILaunchConfiguration config, String testName) throws Exception {
		ILaunch launch;
		URL location = FileLocator.find(getBundle(), new Path("valgrindFiles"), null); //$NON-NLS-1$
		File file = new File(FileLocator.toFileURL(location).toURI());
		IPath pathToFiles = new Path(file.getCanonicalPath()).append(testName);
		
		if (!ValgrindTestsPlugin.RUN_VALGRIND) {
			bindLocation(pathToFiles);
		}

		ILaunchConfigurationWorkingCopy wc = config.getWorkingCopy();
		wc.setAttribute(LaunchConfigurationConstants.ATTR_OUTPUT_DIR, pathToFiles.toOSString());
		Set<String> modes = new HashSet<String>(1);
		modes.add(ILaunchManager.PROFILE_MODE);
		wc.setPreferredLaunchDelegate(modes, ValgrindTestsPlugin.DELEGATE_ID);
		wc.doSave();

		ValgrindTestLaunchDelegate delegate = new ValgrindTestLaunchDelegate();
		launch = new Launch(config, ILaunchManager.PROFILE_MODE, null);
		
		DebugPlugin.getDefault().getLaunchManager().addLaunch(launch);
		launches.add(launch);
		delegate.launch(config, ILaunchManager.PROFILE_MODE, launch, null);
		//launch = config.launch(ILaunchManager.PROFILE_MODE, null, true);
		//DebugPlugin.getDefault().getLaunchManager().removeLaunch(launch);

		if (ValgrindTestsPlugin.GENERATE_FILES) {
			unbindLocation(pathToFiles);
		}
		return launch;
	}

